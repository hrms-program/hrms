<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.paladin.hrms.mapper.report.ReportInforMapper">
            <select id="searchTableList" parameterType="com.paladin.hrms.controller.report.pojo.ReportInforQuery" 
                resultType="com.paladin.hrms.controller.report.pojo.ReportInforDTO">
                  SELECT per.agency_id as org,
					count(per.identification_no) as todo,					
					sum(case when per.report_state=1
							and per.basic_infor_status=1 
							and per.working_infor_status=1
							and per.license_infor_status=1
							and per.education_infor_status=1
							then 1 else 0 end) as y,
					sum(case when per.report_state=1
							and (per.basic_infor_status=0 
							or per.working_infor_status=0
							or per.license_infor_status=0
							or per.education_infor_status=0)
							then 1 else 0 end) as n,
					sum(case when per.report_state=1 then 0 else 1 end ) as un,	<!-- 已上报的不计入 -->
					case org.confirm_state when 1 then '已上报' else '未上报' end as confirmState 
				FROM org_agency ag
				left join report_confirm_org org on ag.id=org.org_id
				left join	v_report_personnel_infor per on ag.id=per.agency_id
				<where>
					and ag.is_delete=0
					<if test="org !=null and org !='' ">
					and ag.id=#{org}
					</if>
				</where>
				group by ag.id
            </select>
            
         <insert id="insertReportPersonnelInfor" parameterType="com.paladin.hrms.model.report.ReportPersonnelInfor">
             insert into report_personnel_infor (id,personnel_id,name,report_state,report_time,report_user,remark,is_delete)
             values(#{id,jdbcType=VARCHAR},#{personnelId,jdbcType=VARCHAR},#{name,jdbcType=VARCHAR},#{reportState,jdbcType=VARCHAR},#{reportTime},
             #{reportUser,jdbcType=VARCHAR},#{remark,jdbcType=VARCHAR},#{isDelete,jdbcType=VARCHAR})
         </insert>   
         
         <select id="findOldEntity" parameterType="String" resultType="com.paladin.hrms.model.report.ReportPersonnelInfor">
              select id,personnel_id as personnelId,name,report_state as reportState from report_personnel_infor
              where personnel_id = #{0}
              and is_delete = '0'
         </select>
         
         <update id="removeReportPersonnelInfor" parameterType="String">
              update report_personnel_infor 
              set is_delete = '1'
              where personnel_id = #{0}
              and is_delete = '0'
         </update>
         
         <select id="searchOrgList" parameterType="com.paladin.hrms.controller.report.pojo.ReportInforQuery" 
                resultType="com.paladin.hrms.controller.report.pojo.ReportInforDTO">
                  SELECT per.agency_id as org,
					count(per.identification_no) as todo,					
					sum(case when per.report_state=1
							and per.basic_infor_status=1 
							and per.working_infor_status=1
							and per.license_infor_status=1
							and per.education_infor_status=1
							then 1 else 0 end) as y,
					sum(case when per.report_state=1
							and (per.basic_infor_status=0 
							or per.working_infor_status=0
							or per.license_infor_status=0
							or per.education_infor_status=0)
							then 1 else 0 end) as n,
					sum(case when per.report_state=1 then 0 else 1 end ) as un,	<!-- 已上报的不计入 -->
					case org.confirm_state when 1 then '已上报' else '未上报' end as confirmState 
				FROM org_agency ag
				left join report_confirm_org org on ag.id=org.org_id
				left join	v_report_personnel_infor per on ag.id=per.agency_id
				<where>
					and ag.is_delete=0
					<if test="org !=null and org !='' ">
					and ag.id=#{org}
					</if>
				</where>
				group by ag.id
            </select>
</mapper>
